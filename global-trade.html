<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Global Trade Network Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* =========================== */
        /* RESET AND BASE STYLES       */
        /* =========================== */
        
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            color: #374151;
            min-height: 100vh;
        }

        /* =========================== */
        /* CONTROL PANEL STYLES        */
        /* =========================== */
        
        #panel-container {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 100;
            max-height: calc(100vh - 48px);
            display: flex;
            transition: width 0.3s ease;
        }

        #control-panel {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            width: 360px;
            max-height: 100%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: width 0.3s ease, padding 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #control-panel.collapsed {
            width: 200px;
        }

        #panel-content {
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        #control-panel.collapsed #panel-content {
            padding: 16px;
        }

        .hide-on-collapse {
            transition: opacity 0.3s ease;
        }

        #control-panel.collapsed .hide-on-collapse {
            display: none;
            opacity: 0;
        }

        /* Panel Header */
        #title {
            padding: 20px 20px 0 20px;
            margin: 0 0 6px 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            line-height: 1.2;
            transition: all 0.3s ease;
        }

        #control-panel.collapsed #title {
            font-size: 1rem;
            padding: 16px 12px 0 12px;
            margin-right: 56px;
        }

        #subtitle {
            padding: 0 20px;
            margin-bottom: 12px;
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
            transition: all 0.3s ease;
        }

        #control-panel.collapsed #subtitle {
            font-size: 0.75rem;
            padding: 0 12px;
            margin-bottom: 8px;
            margin-right: 120px;
        }

        /* Toggle Button */
        #panel-toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        #panel-toggle-btn:hover {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .toggle-icon {
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: transform 0.2s ease;
        }

        .toggle-line {
            width: 12px;
            height: 2px;
            background: #6b7280;
            border-radius: 1px;
            transition: all 0.2s ease;
        }

        #control-panel.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        #panel-toggle-btn:hover .toggle-line {
            background: #374151;
        }

        /* =========================== */
        /* SECTION STYLES              */
        /* =========================== */
        
        .section {
            margin-bottom: 20px;
            padding: 12px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .section:first-child {
            margin-top: 20px;
        }

        .section h3 {
            margin: 0 0 8px 0;
            color: #111827;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .section-description {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 12px;
        }

        /* =========================== */
        /* METRICS GRID                */
        /* =========================== */
        
        #metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .metric-card {
            padding: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .metric-value {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #6b7280;
            margin: 4px 0 0 0;
        }

        /* =========================== */
        /* CONTROLS AND BUTTONS        */
        /* =========================== */
        
        #country-search {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.85rem;
            background: #ffffff;
            color: #374151;
            transition: all 0.2s ease;
        }

        #country-search:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #country-search::placeholder {
            color: #9ca3af;
        }

        #country-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 12px;
            padding-right: 8px;
            max-height: 220px;
            overflow-y: auto;
        }

        .country-toggle {
            padding: 10px 14px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: left;
            color: #374151;
            transition: all 0.2s ease;
        }

        .country-toggle:hover {
            border-color: #9ca3af;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .country-toggle.active {
            background: #10b981;
            border-color: #10b981;
            color: #ffffff;
        }

        .country-toggle.inactive {
            background: #ef4444;
            border-color: #ef4444;
            color: #ffffff;
        }

        .view-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .view-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 1px solid #d1d5db;
            color: #374151;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            flex: 1;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .view-btn:hover {
            border-color: #9ca3af;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .view-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }

        #stats {
            font-size: 0.8rem;
            color: #6b7280;
            text-align: center;
            padding: 8px;
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            margin-bottom: 0;
        }

        /* =========================== */
        /* 2D GRAPH AND LEGEND         */
        /* =========================== */
        
        #graph {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            background: #f8fafc;
        }

        #legend {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 18px;
            z-index: 99;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-width: 180px;
        }

        #legend-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #111827;
            margin: 0 0 10px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.75rem;
            color: #374151;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* =========================== */
        /* TOOLTIP STYLES              */
        /* =========================== */
        
        .tooltip {
            background: rgba(15, 23, 42, 0.95) !important;
            border: 1px solid rgba(148, 163, 184, 0.3) !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            color: #f1f5f9 !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            line-height: 1.4 !important;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important;
            max-width: 200px !important;
        }

        .tooltip-country {
            font-weight: 600 !important;
            color: #ffffff !important;
            margin-bottom: 4px !important;
        }

        /* =========================== */
        /* SCROLLBAR STYLES            */
        /* =========================== */
        
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
    </style>

    <script src="https://unpkg.com/force-graph"></script>
</head>

<body>
    <div id="panel-container">
        <div id="control-panel">
            <button id="panel-toggle-btn">
                <div class="toggle-icon">
                    <span class="toggle-line"></span>
                    <span class="toggle-line"></span>
                    <span class="toggle-line"></span>
                </div>
            </button>
            <h1 id="title">Global Trade Network</h1>
            <p id="subtitle">Interactive 2D visualization of international trade relationships</p>
            
            <div id="panel-content">
                <div class="section hide-on-collapse">
                    <h3>Network Metrics</h3>
                    <p class="section-description">Key measures of network structure</p>
                    <div id="metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="active-countries">0</div>
                            <div class="metric-label">Countries</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="trade-links">0</div>
                            <div class="metric-label">Trade Links</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="network-density">0.000</div>
                            <div class="metric-label">Density</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="avg-centrality">0.000</div>
                            <div class="metric-label">Centrality</div>
                        </div>
                    </div>
                </div>

                <div class="section hide-on-collapse">
                    <h3>View Options</h3>
                    <p class="section-description">Choose how to visualize the network</p>
                    <div class="view-controls">
                        <button class="view-btn" data-view="degree" onclick="app.setView('degree')">Degree</button>
                        <button class="view-btn" data-view="betweenness" onclick="app.setView('betweenness')">Between</button>
                        <button class="view-btn active" data-view="closeness" onclick="app.setView('closeness')">Close</button>
                    </div>
                    <div class="view-controls">
                        <button class="view-btn" data-view="eigenvector" onclick="app.setView('eigenvector')">Eigen</button>
                        <button class="view-btn" data-view="pagerank" onclick="app.setView('pagerank')">PageRank</button>
                        <button class="view-btn" data-view="gdp" onclick="app.setView('gdp')">GDP</button>
                    </div>
                     <div class="view-controls">
                        <button class="view-btn" data-view="population" onclick="app.setView('population')">Population</button>
                        <button class="view-btn" data-view="trade_volume" onclick="app.setView('trade_volume')">Volume</button>
                        <button class="view-btn" data-view="region" onclick="app.setView('region')">Region</button>
                    </div>
                </div>

                <div class="section hide-on-collapse">
                    <h3>Countries</h3>
                    <p class="section-description">Toggle countries on and off</p>
                    <div class="view-controls">
                        <button class="view-btn" onclick="app.selectAll()">All</button>
                        <button class="view-btn" onclick="app.selectNone()">None</button>
                        <button class="view-btn" onclick="app.selectMajor()">Major</button>
                    </div>
                    <input type="text" id="country-search" placeholder="Search countries..." class="hide-on-collapse">
                    <div id="country-grid" class="hide-on-collapse"></div>
                    <div id="stats" class="hide-on-collapse">
                        <span id="active-count">0</span> countries, <span id="link-count">0</span> links
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="legend">
        <h4 id="legend-title">Legend</h4>
    </div>

    <div id="graph"></div>

    <script>
        // =========================== //
        // GLOBAL APPLICATION OBJECT   //
        // =========================== //
        
        const app = {
            // Core data
            countries: [],
            allLinks: [],
            adjacencyMatrix: [],

            // Application state
            graph: null,
            currentView: 'closeness',
            viewMinMax: {},

            // Color schemes
            regionColors: {
                "North America": "#ef4444",
                "South America": "#10b981", 
                "Europe": "#3b82f6",
                "Asia": "#f59e0b",
                "Oceania": "#06b6d4",
                "Middle East": "#d97706",
                "Africa": "#84cc16"
            },

            centralityColors: {
                degree: { high: '#8b5cf6', medium: '#a78bfa', low: '#c4b5fd' },
                betweenness: { high: '#ef4444', medium: '#f87171', low: '#fca5a5' },
                closeness: { high: '#10b981', medium: '#34d399', low: '#6ee7b7' },
                eigenvector: { high: '#f59e0b', medium: '#fbbf24', low: '#fde047' },
                pagerank: { high: '#3b82f6', medium: '#60a5fa', low: '#93c5fd' },
                gdp: { high: '#dc2626', medium: '#f97316', low: '#84cc16' },
                population: { high: '#ec4899', medium: '#f472b6', low: '#f9a8d4' },
                trade_volume: { high: '#06b6d4', medium: '#22d3ee', low: '#67e8f9' }
            },

            async init() {
                await this.loadNetworkData();
                this.precomputeCentrality();
                this.setupEventListeners();
                this.initializeGraph();
            },

            async loadNetworkData() {
                // Mock data
                const mockDataJson = `[
                    {"id":"US","name":"United States","region":"North America","gdp":21430,"population":331002651,"trade_volume":4200000},
                    {"id":"CN","name":"China","region":"Asia","gdp":14340,"population":1439323776,"trade_volume":4600000},
                    {"id":"JP","name":"Japan","region":"Asia","gdp":5080,"population":126476461,"trade_volume":1400000},
                    {"id":"DE","name":"Germany","region":"Europe","gdp":3850,"population":83783942,"trade_volume":2800000},
                    {"id":"IN","name":"India","region":"Asia","gdp":2870,"population":1380004385,"trade_volume":844000},
                    {"id":"GB","name":"United Kingdom","region":"Europe","gdp":2830,"population":67886011,"trade_volume":1300000}
                ]`;
                
                const mockAdjJson = `[
                    [0, 500, 300, 400, 150, 350],
                    [600, 0, 450, 300, 550, 200],
                    [250, 400, 0, 200, 100, 150],
                    [380, 280, 180, 0, 120, 500],
                    [140, 580, 90, 110, 0, 80],
                    [330, 180, 140, 480, 70, 0]
                ]`;

                try {
                    const nodeData = JSON.parse(mockDataJson);
                    this.adjacencyMatrix = JSON.parse(mockAdjJson);

                    this.countries = nodeData.map(node => ({ ...node, active: true }));
                    
                    this.allLinks = [];
                    for (let i = 0; i < this.adjacencyMatrix.length; i++) {
                        for (let j = 0; j < this.adjacencyMatrix[i].length; j++) {
                            const weight = this.adjacencyMatrix[i][j];
                            if (weight > 0) {
                                this.allLinks.push({
                                    source: this.countries[i].id,
                                    target: this.countries[j].id,
                                    value: weight
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.error("Failed to load network data:", error);
                }
            },

            precomputeCentrality() {
                const n = this.countries.length;
                const degree = new Array(n).fill(0);
                
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < n; j++) {
                        if (this.adjacencyMatrix[i][j] > 0) {
                            degree[j]++;
                        }
                        if (this.adjacencyMatrix[j][i] > 0) {
                            degree[j]++;
                        }
                    }
                }
                
                for(let i = 0; i < n; i++) {
                    this.countries[i].degree = degree[i];
                    this.countries[i].closeness = Math.random();
                    this.countries[i].betweenness = Math.random();
                    this.countries[i].eigenvector = Math.random();
                    this.countries[i].pagerank = Math.random();
                }
            },

            setupEventListeners() {
                const panel = document.getElementById('control-panel');
                const toggleBtn = document.getElementById('panel-toggle-btn');
                toggleBtn.onclick = () => {
                    panel.classList.toggle('collapsed');
                };

                const searchInput = document.getElementById('country-search');
                searchInput.addEventListener('input', () => this.updateCountryButtons());
            },

            normalizeValue(value, minInput, maxInput, minOutput, maxOutput) {
                if (minInput === maxInput) return minOutput;
                return minOutput + (maxOutput - minOutput) * (value - minInput) / (maxInput - minInput);
            },

            updateViewMinMax() {
                this.viewMinMax = {
                    degree: { min: Infinity, max: -Infinity },
                    closeness: { min: Infinity, max: -Infinity },
                    betweenness: { min: Infinity, max: -Infinity },
                    eigenvector: { min: Infinity, max: -Infinity },
                    pagerank: { min: Infinity, max: -Infinity },
                    gdp: { min: Infinity, max: -Infinity },
                    population: { min: Infinity, max: -Infinity },
                    trade_volume: { min: Infinity, max: -Infinity }
                };
                
                this.countries.forEach(c => {
                    if (c.active) {
                        for(const view of Object.keys(this.viewMinMax)) {
                            const val = c[view];
                            if (val < this.viewMinMax[view].min) {
                                this.viewMinMax[view].min = val;
                            }
                            if (val > this.viewMinMax[view].max) {
                                this.viewMinMax[view].max = val;
                            }
                        }
                    }
                });
            },

            getColorForValue(value, viewType) {
                if (viewType === 'region') {
                    return this.regionColors[value] || '#6b7280';
                }
                
                const colors = this.centralityColors[viewType] || 
                    this.centralityColors.closeness;
                const { min, max } = this.viewMinMax[viewType] || { min: 0, max: 1 };
                
                if (min === max) return colors.medium;
                
                const normalized = this.normalizeValue(value, min, max, 0, 1);
                
                if (normalized > 0.7) return colors.high;
                if (normalized > 0.4) return colors.medium;
                return colors.low;
            },

            updateGraph() {
                const activeNodes = this.countries.filter(c => c.active);
                const activeNodeIds = new Set(activeNodes.map(n => n.id));

                const activeLinks = this.allLinks.filter(link => 
                    activeNodeIds.has(link.source) && activeNodeIds.has(link.target)
                );

                this.graph.graphData({
                    nodes: activeNodes.map(n => ({...n})),
                    links: activeLinks.map(l => ({...l}))
                });
            },

            updateGraphAppearance() {
                // Custom node rendering with country labels
                this.graph.nodeCanvasObject((node, ctx, globalScale) => {
                    // Get node color based on current view
                    let nodeColor;
                    if (this.currentView === 'region') {
                        nodeColor = this.getColorForValue(node.region, 'region');
                    } else {
                        nodeColor = this.getColorForValue(node[this.currentView], this.currentView);
                    }
                    
                    // Calculate node size based on trade volume
                    const nodeSize = this.normalizeValue(
                        node.trade_volume, 
                        this.viewMinMax.trade_volume?.min || 0, 
                        this.viewMinMax.trade_volume?.max || 1, 
                        4, 12
                    );
                    
                    // Draw the node circle
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, nodeSize, 0, 2 * Math.PI);
                    ctx.fillStyle = nodeColor;
                    ctx.fill();
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    
                    // Draw the country label
                    const label = node.name;
                    const fontSize = Math.max(6, 10 / globalScale);
                    ctx.font = `bold ${fontSize}px Inter, sans-serif`;
                    const textWidth = ctx.measureText(label).width;
                    const bckgDimensions = [textWidth + fontSize * 0.4, fontSize * 1.2];
                    
                    // Draw label background
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.fillRect(
                        node.x - bckgDimensions[0] / 2, 
                        node.y + nodeSize + 4, 
                        bckgDimensions[0], 
                        bckgDimensions[1]
                    );
                    
                    // Draw label border
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(
                        node.x - bckgDimensions[0] / 2, 
                        node.y + nodeSize + 4, 
                        bckgDimensions[0], 
                        bckgDimensions[1]
                    );
                    
                    // Draw label text
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#1f2937';
                    ctx.fillText(label, node.x, node.y + nodeSize + 4 + bckgDimensions[1] / 2);
                    
                    // Store dimensions for hover detection
                    node.__bckgDimensions = bckgDimensions;
                    node.__labelY = node.y + nodeSize + 4;
                    node.__nodeSize = nodeSize;
                });

                // Handle hover area for both node and label
                this.graph.nodePointerAreaPaint((node, color, ctx) => {
                    // Node circle hover area
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, node.__nodeSize || 8, 0, 2 * Math.PI);
                    ctx.fillStyle = color;
                    ctx.fill();
                    
                    // Label hover area
                    if (node.__bckgDimensions) {
                        ctx.fillRect(
                            node.x - node.__bckgDimensions[0] / 2, 
                            node.__labelY, 
                            node.__bckgDimensions[0], 
                            node.__bckgDimensions[1]
                        );
                    }
                });

                // Set up simple tooltips
                this.graph.nodeLabel(node => {
                    const metricValue = typeof node[this.currentView] === 'number' ? 
                        node[this.currentView].toFixed(3) : node[this.currentView];
                    const viewDisplayName = this.currentView.charAt(0).toUpperCase() + 
                        this.currentView.slice(1).replace('_', ' ');
                    
                    return `<div class="tooltip">
                        <div class="tooltip-country">${node.name}</div>
                        <div>${viewDisplayName}: ${metricValue}</div>
                        <div>GDP: $${(node.gdp / 1000).toFixed(1)}T</div>
                        <div>Trade: $${(node.trade_volume / 1e6).toFixed(0)}M</div>
                    </div>`;
                });

                // Update link appearance
                this.graph.linkWidth(link => {
                    const maxWeight = Math.max(...this.allLinks.map(l => l.value));
                    return this.normalizeValue(link.value, 0, maxWeight, 1, 4);
                });

                this.graph.linkColor(() => '#94a3b8');
                
                // Add directional arrows
                this.graph.linkDirectionalArrowLength(link => {
                    const maxWeight = Math.max(...this.allLinks.map(l => l.value));
                    return this.normalizeValue(link.value, 0, maxWeight, 3, 8);
                });
                this.graph.linkDirectionalArrowColor(() => '#64748b');
                this.graph.linkDirectionalArrowRelPos(0.8);
            },

            setView(viewType) {
                this.currentView = viewType;

                document.querySelectorAll('.view-btn').forEach(btn => 
                    btn.classList.remove('active'));
                document.querySelector(`.view-btn[data-view='${viewType}']`)
                    ?.classList.add('active');
                
                this.updateLegend();
                this.updateGraphAppearance();
                this.updateMetrics();
            },

            updateUI() {
                this.updateMetrics();
                this.updateCountryButtons();
                this.updateLegend();
            },

            updateMetrics() {
                const activeNodes = this.countries.filter(c => c.active);
                const activeNodeIds = new Set(activeNodes.map(n => n.id));
                const activeLinks = this.allLinks.filter(link => 
                    activeNodeIds.has(link.source) && activeNodeIds.has(link.target)
                );
                
                const numNodes = activeNodes.length;
                const numLinks = activeLinks.length;
                const density = numNodes > 1 ? 
                    numLinks / (numNodes * (numNodes - 1)) : 0;
                const activeCentralityValues = activeNodes.map(n => n[this.currentView]).filter(v => v !== undefined);
                const avgCentrality = activeCentralityValues.length ? 
                    activeCentralityValues.reduce((sum, val) => sum + val, 0) / activeCentralityValues.length : 0;
                
                const elements = {
                    'active-countries': numNodes,
                    'trade-links': numLinks,
                    'network-density': density.toFixed(3),
                    'avg-centrality': avgCentrality.toFixed(3),
                    'active-count': numNodes,
                    'link-count': numLinks
                };

                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                });
            },

            updateCountryButtons() {
                const container = document.getElementById('country-grid');
                const searchValue = document.getElementById('country-search').value.toLowerCase();
                container.innerHTML = '';
                
                this.countries
                    .filter(c => c.name.toLowerCase().includes(searchValue))
                    .forEach(country => {
                        const button = document.createElement('button');
                        button.className = `country-toggle ${country.active ? 'active' : 'inactive'}`;
                        button.textContent = country.name;
                        button.onclick = () => this.toggleCountry(country);
                        container.appendChild(button);
                    });
            },

            toggleCountry(country) {
                country.active = !country.active;
                this.updateViewMinMax();
                this.updateUI();
                this.updateGraph();
                this.updateGraphAppearance();
            },

            updateLegend() {
                const legendContainer = document.getElementById('legend');
                const titleElement = legendContainer.querySelector('#legend-title');
                
                const existingItems = legendContainer.querySelectorAll('.legend-item, .legend-gradient');
                existingItems.forEach(item => item.remove());
                
                if (this.currentView === 'region') {
                    titleElement.textContent = 'Region';
                    
                    Object.entries(this.regionColors).forEach(([region, color]) => {
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.innerHTML = `
                            <span class="legend-color" style="background-color: ${color};"></span>
                            <span>${region}</span>
                        `;
                        legendContainer.appendChild(legendItem);
                    });
                } else {
                    const { min, max } = this.viewMinMax[this.currentView] || { min: 0, max: 1 };
                    const range = max - min;
                    const colors = this.centralityColors[this.currentView] || this.centralityColors.closeness;
                    
                    titleElement.textContent = this.currentView.charAt(0).toUpperCase() + this.currentView.slice(1).replace('_', ' ');
                    
                    const highThreshold = min + (range * 0.7);
                    const mediumThreshold = min + (range * 0.4);
                    
                    const formatLabel = (val) => {
                        if (val > 1e6) return `${(val / 1e6).toFixed(1)}M`;
                        if (val > 1e3) return `${(val / 1e3).toFixed(1)}K`;
                        return val.toFixed(2);
                    }

                    const legendData = [
                        { color: colors.high, label: `High: > ${formatLabel(highThreshold)}` },
                        { color: colors.medium, label: `Med: > ${formatLabel(mediumThreshold)}` },
                        { color: colors.low, label: `Low: < ${formatLabel(mediumThreshold)}` }
                    ];
                    
                    legendData.forEach(item => {
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.innerHTML = `
                            <span class="legend-color" style="background-color: ${item.color};"></span>
                            <span>${item.label}</span>
                        `;
                        legendContainer.appendChild(legendItem);
                    });
                }
            },

            selectAll() {
                this.countries.forEach(c => c.active = true);
                this.updateViewMinMax();
                this.updateUI();
                this.updateGraph();
                this.updateGraphAppearance();
            },

            selectNone() {
                this.countries.forEach(c => c.active = false);
                this.updateViewMinMax();
                this.updateUI();
                this.updateGraph();
                this.updateGraphAppearance();
            },

            selectMajor() {
                this.countries.forEach(c => c.active = (c.trade_volume > 1000000));
                this.updateViewMinMax();
                this.updateUI();
                this.updateGraph();
                this.updateGraphAppearance();
            },

            initializeGraph() {
                const container = document.getElementById('graph');

                if (typeof ForceGraph === 'undefined') {
                    console.error('ForceGraph library not loaded.');
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; 
                                    height: 100vh; font-size: 1.2rem; color: #ef4444;">
                            Failed to load 2D visualization library
                        </div>
                    `;
                    return;
                }

                this.graph = ForceGraph()(container)
                    .nodeId('id')
                    .backgroundColor('#f8fafc')
                    .linkCurvature(0.25)
                    .cooldownTicks(100)
                    .onNodeClick(node => {
                        // Focus on clicked node
                        this.graph.centerAt(node.x, node.y, 1000);
                        this.graph.zoom(3, 2000);
                    })
                    .onNodeHover(node => {
                        // Change cursor on hover
                        container.style.cursor = node ? 'pointer' : null;
                    });

                this.updateViewMinMax();
                this.updateUI();
                this.updateGraph();
                this.updateGraphAppearance();
                this.setView('closeness');
            }
        };

        // Application startup
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        window.app = app;
    </script>
</body>
</html>